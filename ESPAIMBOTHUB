local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "ESP-AIMBOT",
    Icon = 0,
    LoadingTitle = "Enjoy!",
    LoadingSubtitle = "by PoppinTums",
    Theme = "Amethyst",
    DisableRayfieldPrompts = false,
    DisableBuildWarnings = false,
    ConfigurationSaving = {
        Enabled = true,
        FolderName = nil,
        FileName = "config"
    },
    Discord = {
        Enabled = true,
        Invite = "noinvitelink",
        RememberJoins = true
    },
    KeySystem = true,
    KeySettings = {
        Title = "ESP-AIMBOT",
        Subtitle = "Have Fun!",
        Note = "Key is Hello",
        FileName = "Key",
        SaveKey = true,
        GrabKeyFromSite = false,
        Key = {"Hello"}
    }
})

local MainTab = Window:CreateTab("Main", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483362458)
local CredsTab = Window:CreateTab("Credits", 4483362458)

local Speed25 = MiscTab:CreateButton({
    Name = "Change Speed - 25",
    Callback = function()
        local player = game.Players.LocalPlayer
        local character = player.Character or player.CharacterAdded:Wait()
        local humanoid = character:WaitForChild("Humanoid")

        humanoid.WalkSpeed = 25
    end,
})

local Speed50 = MiscTab:CreateButton({
    Name = "Change Speed - 50",
    Callback = function()
        local player = game.Players.LocalPlayer
        local character = player.Character or player.CharacterAdded:Wait()
        local humanoid = character:WaitForChild("Humanoid")

        humanoid.WalkSpeed = 50
    end,
})

local SpeedReset = MiscTab:CreateButton({
    Name = "Reset/Change Speed - 18",
    Callback = function()
        local player = game.Players.LocalPlayer
        local character = player.Character or player.CharacterAdded:Wait()
        local humanoid = character:WaitForChild("Humanoid")

        humanoid.WalkSpeed = 18
    end,
})

local Creds = CredsTab:CreateButton({
   Name = "Whosvon/PoppinTums",
   Callback = function()
   print("Da King Is Has Arrived")
   end,
})

local CreditsDiscord = CredsTab:CreateButton({
    Name = "Discord - Click To Copy",
    Callback = function()
        setclipboard("https://discord.gg/3vE3JTpbdX")
    end,
})

-- Text Size Slider
local TextSizeSlider = MainTab:CreateSlider({
    Name = "Text Size",
    Range = {10, 40},  -- Set the range of the text size slider
    Increment = 1,     -- Set the increment step to 1
    Suffix = "Size",   -- Label suffix for the slider
    CurrentValue = textSize,
    Flag = "TextSizeSlider",  -- Flag for saving the slider's value
    Callback = function(Value)
        textSize = Value  -- Update textSize with the slider value
        -- Optionally, apply this to the ESP elements if needed
        -- For example, update the ESP text labels if the ESP is already created
    end,
})

-- Color Picker for Text Color
local ColorPicker = MainTab:CreateColorPicker({
    Name = "Text Color",
    Color = textColor,  -- Set default color to white
    Flag = "TextColorPicker",  -- Flag for saving the color value
    Callback = function(Value)
        textColor = Value  -- Update textColor with the color picked
        -- Optionally, apply this to the ESP elements if needed
        -- For example, update the ESP text labels with the new color
    end,
})

-- ESP Button
local ESP = MainTab:CreateButton({
    Name = "ESP-Names",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/whosvon/luaTrident/main/ESP"))()

        -- Assuming you are adding text labels to the ESP
        local function createESPLabel(player)
            -- Create BillboardGui for the player
            local character = player.Character or player.CharacterAdded:Wait()
            local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
            local billboardGui = Instance.new("BillboardGui")
            billboardGui.Adornee = humanoidRootPart
            billboardGui.Size = UDim2.new(2, 0, 2, 0)
            billboardGui.StudsOffset = Vector3.new(0, 2, 0)
            billboardGui.AlwaysOnTop = true

            -- Create the TextLabel for ESP
            local textLabel = Instance.new("TextLabel", billboardGui)
            textLabel.Text = player.Name
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.TextColor3 = textColor  -- Use dynamic text color
            textLabel.TextSize = textSize    -- Use dynamic text size
            textLabel.Font = Enum.Font.SourceSansBold

            -- Add the GUI to the player's character
            billboardGui.Parent = game.CoreGui
        end

        -- Update ESP for existing players
        for _, player in pairs(game.Players:GetPlayers()) do
            if player.Character then
                createESPLabel(player)
            end
        end

        -- Listen for new players joining the game
        game.Players.PlayerAdded:Connect(function(player)
            player.CharacterAdded:Connect(function()
                createESPLabel(player)
            end)
        end)
    end,
})

-- Aimbot Settings
local aimbotEnabled = false
local fovRadius = 100
local smoothness = 0.05

-- Aimbot Toggle
local ToggleAimbot = MainTab:CreateToggle({
    Name = "Enable Aimbot",
    CurrentValue = aimbotEnabled,
    Flag = "AimbotToggle", -- Flag for saving the toggle's state
    Callback = function(Value)
        aimbotEnabled = Value
    end,
})

-- FOV Slider
local FovSlider = MainTab:CreateSlider({
    Name = "FOV Radius",
    Range = {10, 500},
    Increment = 10,
    Suffix = "Units",
    CurrentValue = fovRadius,
    Flag = "FovSlider", -- Flag for saving the slider's value
    Callback = function(Value)
        fovRadius = Value
    end,
})

-- Smoothness Slider
local SmoothnessSlider = MainTab:CreateSlider({
    Name = "Aimbot Smoothness",
    Range = {0.01, 1},
    Increment = 0.01,
    Suffix = "Speed",
    CurrentValue = smoothness,
    Flag = "SmoothnessSlider", -- Flag for saving the slider's value
    Callback = function(Value)
        smoothness = Value
    end,
})

-- Main Code for Aimbot and FOV Logic
local function lockOnHead()
    local camera = workspace.CurrentCamera
    local mousePos = game:GetService("UserInputService"):GetMouseLocation()
    local closestTarget = nil
    local closestDist = math.huge

    -- Loop through all players to find the closest target within the FOV
    for _, player in pairs(game.Players:GetPlayers()) do
        if player.Character and player ~= game.Players.LocalPlayer then
            local head = player.Character:FindFirstChild("Head")
            local humanoid = player.Character:FindFirstChild("Humanoid")
            if head and humanoid then
                local screenPos, onScreen = camera:WorldToViewportPoint(head.Position)
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude

                -- Check if the target is within FOV and visible
                if onScreen and dist < fovRadius and dist < closestDist and isVisible(player) then
                    closestTarget = player
                    closestDist = dist
                end
            end
        end
    end

    -- Lock onto the closest target's head
    if closestTarget then
        local headPos = closestTarget.Character:FindFirstChild("Head").Position
        local humanoidRootPart = closestTarget.Character:FindFirstChild("HumanoidRootPart")
        local humanoid = closestTarget.Character:FindFirstChild("Humanoid")

        if humanoidRootPart and humanoid then
            -- Calculate player's velocity (movement)
            local velocity = humanoidRootPart.Velocity

            -- Predict future position based on velocity
            local predictedHeadPos = headPos + velocity * 0.25 -- Adjust prediction factor if needed

            local cameraPos = camera.CFrame.Position
            local direction = (predictedHeadPos - cameraPos).unit

            -- Calculate the smooth transition
            local targetCFrame = CFrame.new(cameraPos, predictedHeadPos)
            local smoothedCFrame = camera.CFrame:Lerp(targetCFrame, smoothness)
            
            -- Aim at the predicted target's head
            workspace.CurrentCamera.CFrame = smoothedCFrame
        end
    end
end

-- Handle right-click to lock onto the head
local isRightClicking = false
game:GetService("UserInputService").InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then -- Right-click pressed
        isRightClicking = true
        while isRightClicking do
            if aimbotEnabled then
                lockOnHead() -- Keep locking onto the head while right-clicking
            end
            wait(0.05) -- Adjust the speed of locking (smaller value is faster)
        end
    end
end)

game:GetService("UserInputService").InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then -- Right-click released
        isRightClicking = false
    end
end)

-- Helper Function to check if the target is visible
local function isVisible(target)
    local camera = workspace.CurrentCamera
    local head = target.Character:FindFirstChild("Head")
    if not head then return false end

    -- Perform a raycast from the camera to the target's head
    local rayOrigin = camera.CFrame.Position
    local rayDirection = (head.Position - rayOrigin).unit * 1000
    local raycastResult = workspace:Raycast(rayOrigin, rayDirection)

    -- If the raycast hits something other than the target, the target is not visible
    if raycastResult and raycastResult.Instance.Parent ~= target.Character then
        return false
    end
    return true
end
